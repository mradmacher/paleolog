<div class="ui fluid card">
  <div class="content">
    <div class="header">
      <div class="ui ribbon label">section</div>
      <h2 class="ui header section-name"></h2>
      <div class="ui fluid horizontal menu">
        <a class="item occurrences-link" href="#">Section Occurrences</a>
        <a class="item reports-link" href="#">Section Report</a>
        <div class="ui right mini secondary menu">
          <div class="item">
            <button class="ui secondary button edit-section action">Edit Section</button>
          </div>
        </div>
      </div>
    </div>
    <div class="ui description grid">
    </div>

    <template id="section-sample-template">
      <tr>
        <td class="sample-name"></td>
        <td class="sample-description"></td>
        <td class="sample-weight"></td>
        <td>
          <button class="ui mini secondary button edit-sample action" data-sample-id="#">Edit</button>
        </td>
      </tr>
    </template>
    <h3>Samples</h3>
    <table class="ui striped celled table section-samples">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Weight</th>
          <th class="one wide"></th>
        </tr>
      </thead>
      <tbody>
      </tbody>
      <tfoot class="full-width">
        <tr>
          <th colspan="4">
            <button class="ui fluid icon mini secondary button add-sample action"><i class="add icon"></i></button>
          </th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
<script type="text/javascript">
$(function() {
  let projectId = <%= @project.id %>
  let sectionId = <%= @section_id %>
  let projectName = "<%= @project.name %>"

  const new_sample = {
    section_id: <%= @section_id %>,
    name: null,
    description: null,
    weight: null,
  }

  new SectionRequest().get(sectionId).then(
    result => {
      console.log(result)
      let section = result.section

      DomHelpers.setText('.section-name', section.name)
      DomHelpers.setHref('.occurrences-link', UrlBuilder.projectOccurrences(projectId, { projectName: projectName, sectionId: section.id }))
      DomHelpers.setHref('.reports-link', UrlBuilder.projectReports(projectId, { projectName: projectName, sectionId: section.id }))

      let sectionSamplesElement = document.querySelector('.section-samples tbody')
      section.samples.forEach((sample, i) => {
        let template = DomHelpers.getTemplate('section-sample-template')
        DomHelpers.setText('.sample-name', sample.name, template)
        DomHelpers.setText('.sample-description', sample.description, template)
        DomHelpers.setText('.sample-weight', sample.weight, template)

        template.querySelector('.edit-sample.action').addEventListener('click', (event) => {
          new SampleModalFormView(sample, (sample) => window.location.reload()).show()
        })

        sectionSamplesElement.append(template)
      })

      document.querySelector('.edit-section.action').addEventListener('click', (event) => {
        new SectionModalFormView(section, (section) => window.location.reload()).show()
      })
      document.querySelector('.add-sample.action').addEventListener('click', (event) => {
        new SampleModalFormView(new_sample, (sample) => window.location.reload()).show()
      })
    },
    errors => {
      console.log(errors)
    }
  )
});
</script>
